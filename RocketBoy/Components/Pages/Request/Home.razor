@page "/"
@namespace RocketBoy.Components.Pages.Request
@using RocketBoy.Services

<InputFile OnChange="ImportOpenApiFile" class="mb-3" />

<select @onchange="OnCollectionSelected" class="form-select mb-3">
    <option value="">— Load Collection —</option>
    @foreach (var col in AllCollections)
    {
        <option value="@col.Name">@col.Name</option>
    }
</select>

<button class="btn btn-sm btn-outline-primary mb-3"
        @onclick="ShowSaveCollectionDialog">
    Save Current as Collection
</button>

<div class="d-flex flex-wrap mb-3">
    @foreach (var tab in OpenedTabs)
    {
        <div class="me-2 mb-1 d-flex align-items-center">
            <button class="btn @(tab == SelectedTab ? "btn-primary" : "btn-outline-primary")"
                    @onclick="() => SelectTab(tab)">
                @tab.Name
            </button>
            <button type="button"
                    class="btn-close ms-1"
                    aria-label="Close"
                    @onclick="() => CloseTab(tab)" />
        </div>
    }
    <button class="btn btn-outline-secondary mb-1" @onclick="NewTab">
        + New Tab
    </button>
</div>

@if (SelectedTab != null)
{
    <!-- Method + URL -->
    <div class="input-group mb-3">
        <InputSelect @bind-Value="SelectedTab.MethodType"
                     class="form-select"
                     style="width:100px">
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>PATCH</option>
            <option>DELETE</option>
            <option>OPTIONS</option>
        </InputSelect>
        <InputText @bind-Value="SelectedTab.Url"
                   placeholder="Enter request URL"
                   class="form-control" />
    </div>

    <!-- Extra Settings -->
    <details class="mb-3">
        <summary>Additional Settings</summary>
        <div class="p-3 border rounded">
            <div class="mb-2">
                <label>Description</label>
                <InputTextArea @bind-Value="SelectedTab.Description"
                               class="form-control" />
            </div>
            <div class="mb-2">
                <label>Tags (comma-separated)</label>
                <InputText @bind-Value="TagsAsString"
                           class="form-control" />
            </div>
        </div>
    </details>

    <!-- Headers -->
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary me-2"
                @onclick="AddHeader">
            Add Header
        </button>
        <button class="btn btn-sm btn-outline-secondary"
                @onclick="ToggleDefaultHeaders">
            @(ShowDefaultHeaders ? "Hide" : "Show") Default Headers
        </button>
    </div>

    @if (ShowDefaultHeaders)
    {
        @foreach (var hdr in DefaultHeaders)
        {
            <div class="input-group mb-2">
                <InputText @bind-Value="hdr.Name"
                           class="form-control" disabled />
                <InputText @bind-Value="hdr.Value"
                           class="form-control" disabled />
            </div>
        }
    }

    @foreach (var header in SelectedTab.Headers)
    {
        <div class="input-group mb-2">
            <InputText @bind-Value="header.Name"
                       class="form-control"
                       placeholder="Header Name" />
            <InputText @bind-Value="header.Value"
                       class="form-control"
                       placeholder="Header Value" />
            <button class="btn btn-outline-danger"
                    @onclick="() => RemoveHeader(header)">
                Remove
            </button>
        </div>
    }

    <!-- Body -->
    @if (SelectedTab.MethodType is "POST" or "PUT" or "PATCH")
    {
        <div class="mb-3">
            <label>Body</label>
            <textarea class="form-control"
                      rows="5"
                      @onchange="ValidateJson">
        @SelectedTab.Body
              </textarea>
            @if (!isValidJson)
            {
                <div class="text-danger">Invalid JSON</div>
            }
        </div>
    }

    <!-- Tests (now with syntax highlighting via CodeMirror) -->
    <details class="mb-3">
        <summary>Tests (auto-run on Send)</summary>
        <div class="p-3 border rounded">
            <div class="mb-3">
                <label>Pre-Request Script (JS)</label>
                <textarea class="form-control code-editor"
                          @bind="SelectedTab.PreRequestTestJS"></textarea>
                <pre class="mt-2">@SelectedTab.PreTestResults</pre>
            </div>
            <div class="mb-3">
                <label>Post-Request Script (JS)</label>
                <textarea class="form-control code-editor"
                          @bind="SelectedTab.PostRequestTestJS"></textarea>
                <pre class="mt-2">@SelectedTab.PostTestResults</pre>
            </div>
        </div>
    </details>

    <!-- Actions -->
    <div class="mb-3">
        <button class="btn btn-primary me-2" @onclick="SendRequest">
            Send
        </button>
        <button class="btn btn-success me-2" @onclick="SaveRequest">
            Save Request
        </button>
        <button class="btn btn-outline-secondary" @onclick="NewTab">
            New Tab
        </button>
    </div>

    <!-- Response -->
    @if (SelectedTab.Response != null)
    {
        <div class="mt-4">
            <h5>Response: @SelectedTab.Response.StatusCode</h5>
            <pre>@ResponseBodies[SelectedTab]</pre>
        </div>
    }
}
